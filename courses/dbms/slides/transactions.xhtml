<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="ru" xml:lang="ru" xmlns="http://www.w3.org/1999/xhtml"><head><title>Базы данных / Транзакции</title><meta name="author" content="" /><link rel="stylesheet" type="text/css" media="screen, projection, print" href="scripts/slidy.css" /><link rel="stylesheet" type="text/css" href="scripts/prettify.css" /><link rel="stylesheet" type="text/css" href="scripts/kgeorgiy-slides.css" /><script type="text/javascript" src="scripts/slidy.js" charset="utf-8" /><script type="text/javascript" src="scripts/kgeorgiy-slides.js" charset="utf-8" /><script type="text/javascript" src="scripts/prettify.js" /><script type="text/javascript" src="scripts/lang-sql.js" /><script type="text/javascript" src="scripts/lang-javaModule.js" /><script type="text/javascript" src="scripts/lang-scala.js" /><script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-37693764-1"]);_gaq.push(["_setDomainName","kgeorgiy.info"]);_gaq.push(["_trackPageview"]);(function(){var a=document.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})();</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-8EQ66D87ZZ" /><script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());

                  gtag('config', 'G-8EQ66D87ZZ');
                </script></head><body onload="prettyPrint()"><div id="all">
<div class="slide cover"><div class="content"><div class="course">Базы данных</div><hr /><div class="lecture"><div>Транзакции</div></div><div class="link"><a href="https://kgeorgiy.info/courses/dbms/">https://kgeorgiy.info/courses/dbms/</a></div><div class="copyright"><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.ru"><span class="copyright">Copyright © Георгий Корнеев</span><img src="scripts/by-nc-sa.png" alt="Attribution-NonCommercial-ShareAlike" /></a></div></div></div>
<div class="slide section"><div class="content"><h1>Транзакции</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc current">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">2</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Транзакция</h1><div class="body"><ul class="item-1 level-1"><li>Минимальный фиксируемый в БД объем работы</li><li>Неявные транзакции<ul class="item-2 level-2"><li>Для каждого оператора</li></ul></li><li>Нетранзакционные действия<ul class="item-2 level-2"><li>Изменение схемы: <var>create</var>, <var>alter</var>, <var>drop</var></li><li>Часто <var>truncate</var></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">3</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Примеры транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Простая транзакция<ul class="item-2 level-2"><li>Добавление нового счета</li><li><pre class="prettyprint lang-sql">insert into accs (id, money) values (1, 0);
</pre></li></ul></li><li>Составная транзакция<ul class="item-2 level-2"><li>Перевод денег</li><li><pre class="prettyprint lang-sql">update accs set money = money - 100 where id = 1;
update accs set money = money + 100 where id = 2;
</pre></li><li>При переводе количество денег в системе должно сохраняться</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">4</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Управление транзакциями</h1><div class="body"><ul class="item-1 level-1"><li>Старт транзакции<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">start transaction
</pre></li></ul></li><li>Завершение транзакции<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">commit
</pre></li><li>Изменения фиксируются в базе данных</li></ul></li><li>Откат транзакции<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">rollback
</pre></li><li>Изменения игнорируются</li><li>Может производиться автоматически</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">5</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Пример условной транзакции</h1><div class="body"><ul class="item-1 level-1"><li>Перевод денег с проверкой баланса<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">start transaction;
    if ((select money from accs where id = 1) &lt;= 100)
        rollback;
    end if;
    update accs set money = money - 100 where id = 1;
    update accs set money = money + 100 where id = 2;
commit;
</pre></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">6</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Свойства транзакций (ACID)</h1><div class="body"><ul class="item-1 level-1"><li>Атомарность (<var>atomicity</var>)<ul class="item-2 level-2"><li>Все или ничего</li></ul></li><li>Согласованность (<var>consistency</var>)<ul class="item-2 level-2"><li>После транзакции БД остаётся в согласованном состоянии</li></ul></li><li>Изоляция (<var>isolation</var>)<ul class="item-2 level-2"><li>Транзакции не взаимодействуют между собой</li></ul></li><li>Устойчивость (<var>durability</var>)<ul class="item-2 level-2"><li>Изменения не теряются</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">7</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Корректность и согласованность</h1><div class="body"><ul class="item-1 level-1"><li>Согласованность<ul class="item-2 level-2"><li>Состояние БД удовлетворяет ограничениям</li><li>Автоматически проверяется СУБД</li></ul></li><li>Корректность<ul class="item-2 level-2"><li>Состояние БД соответствует реальному миру</li><li>Совместимость + дополнительные ограничения</li></ul></li><li>Сохранение денег при переводе<ul class="item-2 level-2"><li>Невозможно задать ограничениями</li><li>Требуется в реальном мире</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">8</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Минимизация транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Транзакции должны быть по возможности минимальны<ul class="item-2 level-2"><li>Лучше всего – неявные</li></ul></li><li>Препятствия минимизации<ul class="item-2 level-2"><li>Условное обновление</li><li>Множественное обновление</li><li>Промежуточная несовместимость</li></ul></li><li>Человеческий фактор<ul class="item-2 level-2"><li>Завершение транзакции не должно зависеть от людей</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">9</span></div></div></div></div>
<div class="slide section"><div class="content"><h1>Восстановление</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class="">Сбои</a></li><li><a href="#(17)" class="">Журнал транзакций</a></li><li><a href="#(24)" class="">Классический алгоритм восстановления</a></li><li><a href="#(30)" class="">Повторные сбои</a></li><li><a href="#(33)" class="">Алгоритм ARIES</a></li><li><a href="#(39)" class="">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">10</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Сбои</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class=" current">Сбои</a></li><li><a href="#(17)" class="">Журнал транзакций</a></li><li><a href="#(24)" class="">Классический алгоритм восстановления</a></li><li><a href="#(30)" class="">Повторные сбои</a></li><li><a href="#(33)" class="">Алгоритм ARIES</a></li><li><a href="#(39)" class="">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">11</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Устойчивость</h1><div class="body"><ul class="item-1 level-1"><li>Результаты завершённой транзакции сохраняются в БД даже при сбоях</li><li>Оперативная память<ul class="item-2 level-2"><li>Потери при перезагрузке</li><li>⇒ хранение информации на диске</li></ul></li><li>Диски<ul class="item-2 level-2"><li>Избыточность</li><li>Быстрые чтение и запись – последовательные</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">12</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Типы сбоев</h1><div class="body"><ul class="item-1 level-1"><li>Локальный<ul class="item-2 level-2"><li>Одна транзакция</li></ul></li><li>Глобальный<ul class="item-2 level-2"><li>Все транзакции</li></ul></li><li>Аппаратный<ul class="item-2 level-2"><li>Потеря данных в памяти</li></ul></li><li>Отказ оборудования<ul class="item-2 level-2"><li>Потеря данных на дисках</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">13</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Восстановление после сбоя</h1><div class="body"><ul class="item-1 level-1"><li>Транзакции<ul class="item-2 level-2"><li>Подтверждённые – зафиксировать</li><li>Откаченные – откатить</li><li>Незавершённые – откатить</li></ul></li><li><span class="question">Где взять данные для отката?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Копировать данные <br ignore="ignore" />(<var>shadow copy</var>)</div></li><li class="incremental"><div class="non-incremental">Писать изменённые данные в новое место (<var>MVCC</var>)</div></li><li class="incremental"><div class="non-incremental">Писать данные в старое место + журнал изменений (<var>transaction log</var>)</div></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">14</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Теневая копия</h1><div class="body"><ul class="item-1 level-1"><li>Делаем копию БД</li><li>Исполняем транзакцию на ней</li><li>Фиксация<ul class="item-2 level-2"><li>Переключение текущей версии</li></ul></li><li><span class="question">Откат?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Выкидываем копию</div></li></ul></li><li class="incremental"><div class="non-incremental"><span class="question">Производительность?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Ужасающая</div></li></ul></div></li><li class="incremental"><div class="non-incremental"><span class="question">Параллелизм?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Отсутствует</div></li></ul></div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">15</span></div></div></div></div>
<div class="slide"><div class="content"><h1>MVCC</h1><div class="body"><ul class="item-1 level-1"><li>Локальные изменения<ul class="item-2 level-2"><li>Персистентные структуры данных</li></ul></li><li>Фиксация<ul class="item-2 level-2"><li>Объединение изменений</li><li>Переключение текущей версии</li></ul></li><li><span class="question">Откат?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Выкидываем изменения</div></li></ul></li><li class="incremental"><div class="non-incremental"><span class="question">Производительность?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Много памяти</div></li><li class="incremental"><div class="non-incremental">Случайный доступ</div></li></ul></div></li><li class="incremental"><div class="non-incremental"><span class="question">Параллелизм?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Есть</div></li></ul></div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">16</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Журнал транзакций</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class="">Сбои</a></li><li><a href="#(17)" class=" current">Журнал транзакций</a></li><li><a href="#(24)" class="">Классический алгоритм восстановления</a></li><li><a href="#(30)" class="">Повторные сбои</a></li><li><a href="#(33)" class="">Алгоритм ARIES</a></li><li><a href="#(39)" class="">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">17</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Журнал транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Надёжное хранилище изменений<ul class="item-2 level-2"><li>Записывается последовательно</li></ul></li><li>Что записывается<ul class="item-2 level-2"><li>Старые данные</li><li>Новые данные</li><li>Маркеры начала и завершения транзакций</li></ul></li><li>Завершение транзакции<ul class="item-2 level-2"><li>Запись всех изменений в журнал</li><li>Запись маркера завершения транзакции</li><li>Уведомление о завершении транзакции</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">18</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Реализация журнала</h1><div class="body"><ul class="item-1 level-1"><li>Постоянная запись на диск<ul class="item-2 level-2"><li>Много операций</li><li>Данные откаченных транзакций</li><li>Конкуренция за доступ к диску</li></ul></li><li>Запись при завершении<ul class="item-2 level-2"><li>Хранение изменений в памяти</li><li>Запись при завершении</li><li><span class="question">Что делать с большим объёмом данных?</span></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">19</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Точки восстановления</h1><div class="body"><ul class="item-1 level-1"><li>«Слепок» состояния системы<ul class="item-2 level-2"><li>Текущие изменения</li><li>Завершённые транзакции</li><li>Откаченные транзакции</li><li>Открытые транзакции</li></ul></li><li>Требует приостановки изменений<ul class="item-2 level-2"><li>Чем реже – тем лучше</li><li>Чем чаще – тем меньше памяти</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">20</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Структура журнала</h1><div class="body"><ul class="item-1 level-1"><li>Точка восстановления</li><li>События<ul class="item-2 level-2"><li>Идентификатор транзакции</li><li>Указатель на предыдущее событие транзакции</li></ul></li><li>Типы событий<ul class="item-2 level-2"><li>Начало транзакции</li><li>Изменение</li><li>Завершение транзакции</li><li>Откат транзакции</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">21</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Транзакции после сбоя (1) </h1><div class="body"><img class="bottom" src="pics/Recovery_TransactionLog_1.svg" /></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">22</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Транзакции после сбоя (2) </h1><div class="body"><img class="bottom" src="pics/Recovery_TransactionLog_2.svg" /><ul class="item-1 level-1"><li>Обязательное поведение</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">23</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Классический алгоритм восстановления</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class="">Сбои</a></li><li><a href="#(17)" class="">Журнал транзакций</a></li><li><a href="#(24)" class=" current">Классический алгоритм восстановления</a></li><li><a href="#(30)" class="">Повторные сбои</a></li><li><a href="#(33)" class="">Алгоритм ARIES</a></li><li><a href="#(39)" class="">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">24</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Восстановление после сбоя</h1><div class="body"><ul class="item-1 level-1"><li>Фазы классического алгоритма<ul class="item-2 level-2"><li>Разметка транзакций</li><li>Откат транзакций</li><li>Повтор транзакций</li></ul></li><li>Множества транзакций<ul class="item-2 level-2"><li><var>Redo</var> – повторить (накатить)</li><li><var>Undo</var> – откатить</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">25</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Фаза разметки транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Разбиение транзакций на <var>Redo</var> и <var>Undo</var></li><li>Чтение журнала<ul class="item-2 level-2"><li>От последней контрольной точки до конца</li></ul></li><li>Алгоритм<ul class="item-2 level-2"><li>Контрольная точка – поместить все открытые транзакции в <var>Undo</var></li><li>Маркер начала – добавить транзакцию в <var>Undo</var></li><li>Маркер конца – перенести транзакцию из <var>Undo</var> в <var>Redo</var></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">26</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Фаза отката транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Откат транзакций из <var>Undo</var></li><li>Чтение журнала<ul class="item-2 level-2"><li>От конца к началу</li><li>Пока <var>Undo</var> не пуст</li></ul></li><li>Алгоритм<ul class="item-2 level-2"><li>Маркер начала – удалить транзакцию из <var>Undo</var></li><li>Изменение – если транзакция в <var>Undo</var>, откатить</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">27</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Фаза повторения транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Повтор транзакций из <var>Redo</var></li><li>Чтение журнала<ul class="item-2 level-2"><li>От последней контрольной точки до конца</li></ul></li><li>Алгоритм<ul class="item-2 level-2"><li>Маркер конца – удалить транзакцию из <var>Redo</var></li><li>Изменение – если транзакция в <var>Redo</var>, применить</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">28</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Длина журнала</h1><div class="body"><ul class="item-1 level-1"><li><span class="question">Когда можно удалять данные из журнала?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">Закончены все открытые транзакции</div></li><li class="incremental"><div class="non-incremental">По точкам восстановления</div></li><li class="incremental"><div class="non-incremental">Удаляется префикс</div></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">29</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Повторные сбои</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class="">Сбои</a></li><li><a href="#(17)" class="">Журнал транзакций</a></li><li><a href="#(24)" class="">Классический алгоритм восстановления</a></li><li><a href="#(30)" class=" current">Повторные сбои</a></li><li><a href="#(33)" class="">Алгоритм ARIES</a></li><li><a href="#(39)" class="">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">30</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Повторные сбои</h1><div class="body"><ul class="item-1 level-1"><li>Сбои во время восстановления</li><li>Восстановление в памяти<ul class="item-2 level-2"><li>Устойчиво к повторным сбоям</li><li>Памяти для <var>Undo</var> может не хватить</li><li><span class="question">Почему хватит памяти для <var>Redo</var>?</span></li></ul></li><li class="incremental"><div class="non-incremental">Запись на диск<ul class="item-2 level-2"><li>Дополнение журнала транзакций</li></ul></div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">31</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Классический алгоритм</h1><div class="body"><ul class="item-1 level-1"><li>Откат изменения – тоже изменение</li><li>Действия при откате<ul class="item-2 level-2"><li>Откатить изменение</li><li>Внести запись об обратном изменении</li></ul></li><li>Повторение всех действий при сбое<ul class="item-2 level-2"><li>Рост анализируемой части журнала</li></ul></li><li><span class="question">Что делать?</span></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">32</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Алгоритм ARIES</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class="">Сбои</a></li><li><a href="#(17)" class="">Журнал транзакций</a></li><li><a href="#(24)" class="">Классический алгоритм восстановления</a></li><li><a href="#(30)" class="">Повторные сбои</a></li><li><a href="#(33)" class=" current">Алгоритм ARIES</a></li><li><a href="#(39)" class="">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">33</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Алгоритм ARIES</h1><div class="body"><ul class="item-1 level-1"><li>Фазы алгоритма<ul class="item-2 level-2"><li>Разметка транзакций</li><li>Повторение истории</li><li>Откат транзакций</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">34</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Фаза повторения истории</h1><div class="body"><ul class="item-1 level-1"><li>Восстановление состояния системы на момент сбоя</li><li>Чтение журнала<ul class="item-2 level-2"><li>От последней контрольной точки до конца</li></ul></li><li>Алгоритм<ul class="item-2 level-2"><li>Изменение – применить</li></ul></li><li>Можно объединить с разметкой транзакций</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">35</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Фаза отката транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Восстановление корректного состояния системы</li><li>Чтение журнала<ul class="item-2 level-2"><li>Для транзакций из <var>Undo</var></li><li>От конца к началу</li></ul></li><li>Алгоритм<ul class="item-2 level-2"><li>Изменение – откатить</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">36</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Повторные сбои</h1><div class="body"><ul class="item-1 level-1"><li>Компенсационные записи <img class="bottom" src="pics/Recovery_ARIES.svg" /></li><li>Действия при откате<ul class="item-2 level-2"><li>Откатить изменение</li><li>Записать на диск</li><li>Внести компенсационную запись</li></ul></li><li>Повторение действий не требуется</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">37</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Классический алг. vs ARIES</h1><div class="body"><ul class="item-1 level-1"><li>Количество проходов<ul class="item-2 level-2"><li>Классический алгоритм – 3</li><li>ARIES – 2</li></ul></li><li>Рост журнала транзакций<ul class="item-2 level-2"><li>Классический алгоритм – записи отмены</li><li>ARIES – компенсационные записи</li></ul></li><li>Повторные сбои<ul class="item-2 level-2"><li>Классический алгоритм – потеря эффективности</li><li>ARIES – постепенное завершение</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">38</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Отказ оборудования</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc current">Восстановление</a><ol class="level-2 toc-2"><li><a href="#(11)" class="">Сбои</a></li><li><a href="#(17)" class="">Журнал транзакций</a></li><li><a href="#(24)" class="">Классический алгоритм восстановления</a></li><li><a href="#(30)" class="">Повторные сбои</a></li><li><a href="#(33)" class="">Алгоритм ARIES</a></li><li><a href="#(39)" class=" current">Отказ оборудования</a></li></ol></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">39</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Методы борьбы</h1><div class="body"><ul class="item-1 level-1"><li>Репликация данных</li><li>Избыточность оборудования</li><li>Резервное копирование</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">40</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Репликация данных</h1><div class="body"><ul class="item-1 level-1"><li>Несколько БД, содержащих одинаковые данные<ul class="item-2 level-2"><li>Желательно в разных местах</li></ul></li><li>В процессе работы<ul class="item-2 level-2"><li>Поддержка синхронности</li><li>Распределённые транзакции</li></ul></li><li>При отказе<ul class="item-2 level-2"><li>Копия назначается основной базой</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">41</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Избыточность оборудования</h1><div class="body"><ul class="item-1 level-1"><li>Несколько копий данных БД<ul class="item-2 level-2"><li>В одной системе</li></ul></li><li>В процессе работы<ul class="item-2 level-2"><li>Параллельная запись</li><li>RAID</li></ul></li><li>При отказе<ul class="item-2 level-2"><li>Замена диска</li><li>Копирование данных</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">42</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Резервное копирование</h1><div class="body"><ul class="item-1 level-1"><li>Периодическое копирование всей БД<ul class="item-2 level-2"><li>Хранится отдельно</li></ul></li><li>В процессе работы<ul class="item-2 level-2"><li>Получение «слепков» базы</li><li>Немного устаревшие данные</li></ul></li><li>При отказе<ul class="item-2 level-2"><li>Восстановление данных из «слепка»</li><li>Повторное внесение данных</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">43</span></div></div></div></div>
<div class="slide section"><div class="content"><h1>Параллельное исполнение</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc current">Параллельное исполнение</a><ol class="level-2 toc-2"><li><a href="#(45)" class="">Изоляция и конфликты</a></li><li><a href="#(52)" class="">Блокировки</a></li><li><a href="#(58)" class="">Упорядочиваемость</a></li><li><a href="#(61)" class="">Восстановление</a></li><li><a href="#(65)" class="">Гранулярность блокировок</a></li></ol></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">44</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Изоляция и конфликты</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc current">Параллельное исполнение</a><ol class="level-2 toc-2"><li><a href="#(45)" class=" current">Изоляция и конфликты</a></li><li><a href="#(52)" class="">Блокировки</a></li><li><a href="#(58)" class="">Упорядочиваемость</a></li><li><a href="#(61)" class="">Восстановление</a></li><li><a href="#(65)" class="">Гранулярность блокировок</a></li></ol></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">45</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Изоляция</h1><div class="body"><ul class="item-1 level-1"><li>Транзакции могут исполняться параллельно<ul class="item-2 level-2"><li>Транзакция должна исполняться так, как будто она в системе одна</li><li>Транзакции, корректные по отдельности, должны быть корректны в совокупности</li></ul></li><li>Исполнение транзакций в разных потоках<ul class="item-2 level-2"><li>Синхронизация</li><li>Блокировки</li></ul></li><li><span class="question">Каких проблем можно ожидать?</span></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">46</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Потерянное обновление (1)</h1><div class="body"><ul class="item-1 level-1"><li>Обновление, сделанное транзакцией 1, потеряно <table><tr><th> Транзакция 1 </th><th> Транзакция 2</th></tr><tr><td><var>retrieve v</var><br ignore="ignore" /><br ignore="ignore" /><var>update v</var><br ignore="ignore" /><br ignore="ignore" /><var>commit</var><br ignore="ignore" /> </td><td><br ignore="ignore" /><var>retrieve v</var><br ignore="ignore" /><br ignore="ignore" /><var>update v</var><br ignore="ignore" /><br ignore="ignore" /><var>commit</var></td></tr></table></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">47</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Потерянное обновление (2)</h1><div class="body"><ul class="item-1 level-1"><li>Обновление, сделанное транзакцией 1, потеряно <table><tr><th> Транзакция 1 </th><th> Транзакция 2</th></tr><tr><td><br ignore="ignore" /><var>update v</var><br ignore="ignore" /><var>commit</var><br ignore="ignore" /><br ignore="ignore" /></td><td><var>update v</var><br ignore="ignore" /><br ignore="ignore" /><br ignore="ignore" /><var>rollback</var><br ignore="ignore" /></td></tr></table></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">48</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Незафиксированное изменение</h1><div class="body"><ul class="item-1 level-1"><li>Значение, полученное транзакцией 1, не было зафиксировано <table><tr><th> Транзакция 1 </th><th> Транзакция 2</th></tr><tr><td><br ignore="ignore" /><var>retrieve v</var><br ignore="ignore" /><br ignore="ignore" /><var>commit</var></td><td><var>update v</var><br ignore="ignore" /><br ignore="ignore" /><var>rollback</var><br ignore="ignore" /><br ignore="ignore" /></td></tr></table></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">49</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Несогласованное состояние</h1><div class="body"><ul class="item-1 level-1"><li>Значение, полученное транзакцией 1, не могло быть получено в согласованном состоянии <table><tr><th> Транзакция 1 </th><th> Транзакция 2</th></tr><tr><td><br ignore="ignore" /><var>retrieve v_1</var><br ignore="ignore" /><var>retrieve v_2</var><br ignore="ignore" /><br ignore="ignore" /><var>commit</var><br ignore="ignore" /><br ignore="ignore" /></td><td><var>update v_1 = v_1 - 10</var><br ignore="ignore" /><br ignore="ignore" /><br ignore="ignore" /><var>update v_2 = v_2 + 10</var><br ignore="ignore" /><br ignore="ignore" /><var>commit</var></td></tr></table></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">50</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Типы конфликтов</h1><div class="body"><ul class="item-1 level-1"><li>Чтение – чтение<ul class="item-2 level-2"><li>Нет конфликтов</li></ul></li><li>Чтение – запись<ul class="item-2 level-2"><li>Некорректное состояние</li></ul></li><li>Запись – чтение<ul class="item-2 level-2"><li>Зависимость от незафиксированного изменения</li></ul></li><li>Запись – запись<ul class="item-2 level-2"><li>Потерянное обновление</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">51</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Блокировки</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc current">Параллельное исполнение</a><ol class="level-2 toc-2"><li><a href="#(45)" class="">Изоляция и конфликты</a></li><li><a href="#(52)" class=" current">Блокировки</a></li><li><a href="#(58)" class="">Упорядочиваемость</a></li><li><a href="#(61)" class="">Восстановление</a></li><li><a href="#(65)" class="">Гранулярность блокировок</a></li></ol></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">52</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Блокировки</h1><div class="body"><ul class="item-1 level-1"><li>Типы блокировок<ul class="item-2 level-2"><li><var>–</var> отсутствует</li><li><var>S</var> разделяемая, для чтения</li><li><var>X</var> эксклюзивная, для чтения и записи</li></ul></li><li>Совместимость блокировок <table><tr><td /><td><var>–</var></td><td><var>S</var></td><td><var>X</var></td></tr><tr><td><var>–</var></td><td> + </td><td> + </td><td> +</td></tr><tr><td><var>S</var></td><td> + </td><td> + </td><td> −</td></tr><tr><td><var>X</var></td><td> + </td><td> − </td><td> −</td></tr></table></li><li class="incremental"><div class="non-incremental">В <var>MVCC</var> часто блокировки только на запись<ul class="item-2 level-2"><li>Для чтения у каждого своя копия</li></ul></div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">53</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Строгий протокол двухфазной блок.</h1><div class="body"><ul class="item-1 level-1"><li>Чтение<ul class="item-2 level-2"><li>Получение <var>S</var></li></ul></li><li>Запись<ul class="item-2 level-2"><li>Получение <var>X</var></li></ul></li><li>Завершение или откат транзакции<ul class="item-2 level-2"><li>Освобождение всех блокировок</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">54</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Взаимная блокировка</h1><div class="body"><ul class="item-1 level-1"><li>Пример взаимной блокировки (ВБ) <table><tr><th> Транзакция 1 </th><th> Транзакция 2</th></tr><tr><td><var>retrieve v_1</var><br ignore="ignore" /><br ignore="ignore" /><var>update v_2</var><br ignore="ignore" /><br ignore="ignore" /></td><td><br ignore="ignore" /><var>retrieve v_2</var><br ignore="ignore" /><br ignore="ignore" /><var>update v_1</var></td></tr></table></li><li><span class="question">Что делать?</span></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">55</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Устранение ВБ</h1><div class="body"><ul class="item-1 level-1"><li>Строим граф ожиданий<ul class="item-2 level-2"><li>Если есть цикл – ВБ</li></ul></li><li>Ставим таймауты<ul class="item-2 level-2"><li>Если долго нет прогресса – скорее всего ВБ</li></ul></li><li>Обнаружена ВБ<ul class="item-2 level-2"><li>Откатываем одну из транзакций</li><li>При возможности, автоматически перезапускаем транзакции</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">56</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Предотвращение ВБ</h1><div class="body"><ul class="item-1 level-1"><li>Стратегия обработки конфликтов<ul class="item-2 level-2"><li>Транзакция <var>A</var> претендует на блокировку, конфликтующую с блокировками транзакции <var>B</var></li></ul></li><li>Стратегия ожидание-отмена<ul class="item-2 level-2"><li><var>A</var> началась раньше <var>B</var> ⇒ <var>A</var> ожидает</li><li><var>A</var> началась позже <var>B</var> ⇒ <var>A</var> отменяется</li></ul></li><li>Стратегия отмена-ожидание<ul class="item-2 level-2"><li><var>A</var> началась раньше <var>B</var> ⇒ <var>B</var> отменяется</li><li><var>A</var> началась позже <var>B</var> ⇒ <var>A</var> ожидает</li></ul></li><li class="incremental"><div class="non-incremental"><span class="question">Почему стратегии работают?</span></div></li><li class="incremental"><div class="non-incremental">Стратегии порождают много лишних откатов</div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">57</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Упорядочиваемость</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc current">Параллельное исполнение</a><ol class="level-2 toc-2"><li><a href="#(45)" class="">Изоляция и конфликты</a></li><li><a href="#(52)" class="">Блокировки</a></li><li><a href="#(58)" class=" current">Упорядочиваемость</a></li><li><a href="#(61)" class="">Восстановление</a></li><li><a href="#(65)" class="">Гранулярность блокировок</a></li></ol></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">58</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Упорядочиваемость</h1><div class="body"><ul class="item-1 level-1"><li>Любая последовательность исполнения транзакций эквивалентна какому-то последовательному исполнению<ul class="item-2 level-2"><li>Последовательное исполнение – транзакции выполняются одна за другой</li><li>Эквивалентность исполнений – равенство состоянии до начала ⇒ равенство состояний после окончания</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">59</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Упорядочив. и блокировки</h1><div class="body"><ul class="item-1 level-1"><li>Строгий протокол двухфазной блокировки гарантирует упорядочиваемость</li><li>Двухфазная блокировка<ul class="item-2 level-2"><li>Получение блокировки до операции</li><li>После отпускания любой блокировки больше получать блокировки нельзя</li></ul></li><li>Теорема о двухфазной блокировке<ul class="item-2 level-2"><li>Если все транзакции используют протокол двухфазной блокировки ⇒ все исполнения упорядочиваемы</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">60</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Восстановление</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc current">Параллельное исполнение</a><ol class="level-2 toc-2"><li><a href="#(45)" class="">Изоляция и конфликты</a></li><li><a href="#(52)" class="">Блокировки</a></li><li><a href="#(58)" class="">Упорядочиваемость</a></li><li><a href="#(61)" class=" current">Восстановление</a></li><li><a href="#(65)" class="">Гранулярность блокировок</a></li></ol></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">61</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Восстановление и параллелизм</h1><div class="body"><ul class="item-1 level-1"><li>Пример конфликта <table><tr><th> Транзакция 1 </th><th> Транзакция 2</th></tr><tr><td><br ignore="ignore" /><var>retrieve v</var><br ignore="ignore" /><var>commit</var><br ignore="ignore" /><br ignore="ignore" /></td><td><var>update v</var><br ignore="ignore" /><br ignore="ignore" /><br ignore="ignore" /><var>rollback</var></td></tr></table></li><li>Зафиксировано изменение, зависящее от незафиксированного</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">62</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Восстанавливаемость</h1><div class="body"><ul class="item-1 level-1"><li>Критерий восстанавливаемости<ul class="item-2 level-2"><li>Если транзакция <var>A</var> использует значения, обновлённые транзакцией <var>B</var>, то <var>A</var> должна завершиться позже чем <var>B</var></li></ul></li><li><span class="question">Почему не бывает противоречий?</span><ul class="item-2 level-2"><li class="incremental"><div class="non-incremental">В случае противоречия возникает ВБ</div></li></ul></li><li class="incremental"><div class="non-incremental">Форсированные откаты<ul class="item-2 level-2"><li>Откат транзакции <var>B</var> форсирует откат транзакции <var>A</var></li><li>Цепочки откатов</li></ul></div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">63</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Отсутствие цепочек откатов</h1><div class="body"><ul class="item-1 level-1"><li>Критерий<ul class="item-2 level-2"><li>Если транзакция <var>A</var> использует значения, обновлённые транзакцией <var>B</var>, то <var>A</var> не может завершиться до завершения <var>B</var></li></ul></li><li><span class="question">Почему строгий протокол блокировки удовлетворяет критерию?</span></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">64</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Гранулярность блокировок</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc current">Параллельное исполнение</a><ol class="level-2 toc-2"><li><a href="#(45)" class="">Изоляция и конфликты</a></li><li><a href="#(52)" class="">Блокировки</a></li><li><a href="#(58)" class="">Упорядочиваемость</a></li><li><a href="#(61)" class="">Восстановление</a></li><li><a href="#(65)" class=" current">Гранулярность блокировок</a></li></ol></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">65</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Типы блокировок</h1><div class="body"><ul class="item-1 level-1"><li>Блокировка записи/полей<ul class="item-2 level-2"><li>Блокировка страницы</li></ul></li><li>Блокировка таблицы<ul class="item-2 level-2"><li>Блокировка индекса</li></ul></li><li>Блокировка базы данных</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">66</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Блокировки записей/полей</h1><div class="body"><ul class="item-1 level-1"><li>Блокировки записей/полей<ul class="item-2 level-2"><li>Блокируются<ul class="item-3 level-3"><li>Записи целиком</li><li>Отдельные поля</li></ul></li><li>Высокий параллелизм</li><li>Много ресурсов</li></ul></li><li>Блокировки страниц<ul class="item-2 level-2"><li>Блокируется страница, содержащая запись</li></ul></li><li>Эскалация блокировки</li><li>Фантомные записи<ul class="item-2 level-2"><li>При повторном чтении могут появиться новые записи</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">67</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Блокировки таблиц</h1><div class="body"><ul class="item-1 level-1"><li>Блокировки таблиц<ul class="item-2 level-2"><li>Блокируются таблицы целиком</li><li>Низкий параллелизм</li><li>Мало ресурсов</li><li>Отсутствие фантомов</li></ul></li><li>Блокировки индексов<ul class="item-2 level-2"><li>Блокируется элемент или страница индекса</li><li>⇒ запрет на добавление и удаление</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">68</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Блокировка базы данных</h1><div class="body"><ul class="item-1 level-1"><li>Резервное копирование</li><li>Изменение определений таблиц и представлений</li><li>Изменение хранимых процедур и функций</li><li>Изменение прав доступа</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">69</span></div></div></div></div>
<div class="slide section"><div class="content"><h1>Транзакции в SQL</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc current">Транзакции в SQL</a><ol class="level-2 toc-2"><li><a href="#(71)" class="">Уровни изоляции транзакций</a></li><li><a href="#(79)" class="">Синтаксис</a></li></ol></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">70</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Уровни изоляции транзакций</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc current">Транзакции в SQL</a><ol class="level-2 toc-2"><li><a href="#(71)" class=" current">Уровни изоляции транзакций</a></li><li><a href="#(79)" class="">Синтаксис</a></li></ol></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">71</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Уровни изоляции транзакций</h1><div class="body"><ul class="item-1 level-1"><li>Упорядочиваемый (<var>serializable</var>)<ul class="item-2 level-2"><li>Наиболее сильные гарантии</li><li>Самое медленное исполнение</li></ul></li><li>«Слепок» (<var>snapshot</var>)</li><li>Повторяемое чтение (<var>repeatable read</var>)</li><li>Чтение зафиксированных (<var>read committed</var>)</li><li>Чтение незафиксированных (<var>read uncommitted</var>)</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">72</span></div></div></div></div>
<div class="slide"><div class="content"><h1>«Слепок»</h1><div class="body"><ul class="item-1 level-1"><li>Каждая транзакция работает со своим «слепком» БД<ul class="item-2 level-2"><li>Используется вместо упорядочиваемого</li><li>Не соответствует SQL</li></ul></li><li>Реинтеграция изменений<ul class="item-2 level-2"><li>Изменения фиксируются при отсутствии конфликтов изменений</li></ul></li><li>Аномалия «косая запись»<ul class="item-2 level-2"><li><var>Serialization anomaly</var></li><li>Одновременное обновление разных записей, основанное на одних и тех же данных</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">73</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Пример «косой записи»</h1><div class="body"><ul class="item-1 level-1"><li>Инвариант <var>v_1 + v_2 ≥ 0</var><ul class="item-2 level-2"><li>Транзакция 1 <pre class="prettyprint lang-sql">if v_1 + v_2 ≥ Δ then
   v_1 = v_1 − Δ
end if
</pre></li><li>Транзакция 2 <pre class="prettyprint lang-sql">if v_1 + v_2 ≥ Δ then
   v_2 = v_2 − Δ
end if
</pre></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">74</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Повторяемое чтение</h1><div class="body"><ul class="item-1 level-1"><li>При повторном чтении значения не меняются</li><li>Блокировка записей или страниц на чтение</li><li>Аномалия «фантомная запись»<ul class="item-2 level-2"><li><var>Phantom read</var></li><li>При повторном чтении могут появиться новые записи</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">75</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Чтение зафиксированных</h1><div class="body"><ul class="item-1 level-1"><li>Чтение значений, зафиксированных другими транзакциями</li><li>Частичные блокировки записей или страниц</li><li>Аномалия «неповторяемое чтение»<ul class="item-2 level-2"><li><var>Nonrepeatable read</var></li><li>При повторном чтении значение может измениться</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">76</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Чтение незафиксированных</h1><div class="body"><ul class="item-1 level-1"><li>Чтение текущих значений<ul class="item-2 level-2"><li>В SQL – только чтение</li></ul></li><li>Блокировки отсутствуют</li><li>Аномалия «грязное чтение»<ul class="item-2 level-2"><li><var>Dirty read</var></li><li>Может быть прочитано незафиксированное значение</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">77</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Уровни изоляции и аномалии </h1><div class="body"><table><tr><td> Аномалия / Уровень </td><th class="center">   S   </th><th> SN </th><th> RR </th><th> RC </th><th> RU</th></tr><tr><td> Косая запись </td><td class="center"> − </td><td class="center"> + </td><td class="center"> + </td><td class="center"> + </td><td class="center"> +</td></tr><tr><td> Фантомная запись </td><td class="center"> − </td><td class="center"> − </td><td class="center"> + </td><td class="center"> + </td><td class="center"> +</td></tr><tr><td> Неповторяемое чтение </td><td class="center"> − </td><td class="center"> − </td><td class="center"> − </td><td class="center"> + </td><td class="center"> +</td></tr><tr><td> Грязное чтение </td><td class="center"> − </td><td class="center"> − </td><td class="center"> − </td><td class="center"> − </td><td class="center"> +</td></tr></table></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">78</span></div></div></div></div>
<div class="slide subsection"><div class="content"><h1>Синтаксис</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc current">Транзакции в SQL</a><ol class="level-2 toc-2"><li><a href="#(71)" class="">Уровни изоляции транзакций</a></li><li><a href="#(79)" class=" current">Синтаксис</a></li></ol></li><li><a href="#(85)" class="toc">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">79</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Начало транзакции</h1><div class="body"><ul class="item-1 level-1"><li>Синтаксис<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">start transaction [режим] [изоляция] [настройки]
</pre></li></ul></li><li>Режим<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">read {only | write}
</pre></li><li>По умолчанию – чтение и запись (если не <var>RU</var>)</li></ul></li><li>Изоляция<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">[isolation level уровень]
</pre></li><li>По умолчанию – упорядочиваемый</li></ul></li><li>Начинает транзакцию с указанными уровнями доступа и изоляции</li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">80</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Конец транзакции</h1><div class="body"><ul class="item-1 level-1"><li>Синтаксис<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">commit [work] [and [no] chain]
</pre></li><li><pre class="prettyprint lang-sql">rollback [work] [and [no] chain]
</pre></li></ul></li><li>Фиксирует или откатывает транзакцию<ul class="item-2 level-2"><li><var>work</var> – ничего не значит</li><li><var>and chain</var> – сразу начать новую транзакцию с теми же настройками</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">81</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Вложенные транзакции</h1><div class="body"><ul class="item-1 level-1"><li>Пример 1<ul class="item-2 level-2"><li><span class="warn"><pre class="prettyprint lang-sql">start transaction isolation level serializable;
    // 1
start transaction isolation level read committed;
    // 2
</pre></span></li></ul></li><li class="incremental"><div class="non-incremental">Пример 2<ul class="item-2 level-2"><li><span class="warn"><pre class="prettyprint lang-sql">start transaction isolation level read committed;
    // 1
start transaction isolation level serializable;
    // 2
commit and no chain;
    // 3
rollback;
</pre></span></li></ul></div></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">82</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Точки сохранения</h1><div class="body"><ul class="item-1 level-1"><li>Создание точки сохранения<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">savepoint имя
</pre></li><li>Имя локально внутри транзакции</li></ul></li><li>Возвращается к точке сохранения<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">rollback to savepoint имя
</pre></li><li>Позволяет делать частичный откат транзакции</li></ul></li><li>Отмена точки сохранения<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">release savepoint имя
</pre></li><li>Освобождает ресурсы</li><li>После окончания транзакции все точки сохранения отменяются</li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">83</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Ограничения</h1><div class="body"><ul class="item-1 level-1"><li>Объявление<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">add constraint ... режим
</pre></li><li><var>not deferrable</var> – не откладываемая</li><li><var>deferrable initially immediate</var> – отклад. по запросу</li><li><var>deferrable initially deferred</var> – отклад. по умолчанию<ul class="item-3 level-3"><li>Не рекомендуется</li></ul></li></ul></li><li>Установка режима<ul class="item-2 level-2"><li><pre class="prettyprint lang-sql">set constraints {all|имена} {deferred|immediate}
</pre></li><li><var>immediate</var> – после каждого запроса</li><li><var>deferred</var> – при завершении транзакций</li><li><span class="question">Когда может упасть?</span> !*** Проверка при <var>deferred</var> → <var>immediate</var></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">84</span></div></div></div></div>
<div class="slide section"><div class="content"><h1>Литература</h1><h2>Содержание</h2><div class="body"><ol class="level-1 toc-1"><li><a href="#(2)" class="toc">Транзакции</a></li><li><a href="#(10)" class="toc">Восстановление</a></li><li><a href="#(44)" class="toc">Параллельное исполнение</a></li><li><a href="#(70)" class="toc">Транзакции в SQL</a></li><li><a href="#(85)" class="toc current">Литература</a></li></ol></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">85</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Основная литература</h1><div class="body"><ul class="item-1 level-1"><li><em>Дейт К.</em> Введение в системы баз данных (главы 15 и 16)</li><li><em>Уидом Д., Ульман Д.</em> Основы реляционных баз данных (раздел 7.2)</li><li><em>Gulutzan P.</em>, <em>Pelzer T.</em> SQL-99 complete, really<ul class="item-2 level-2"><li><a href="https://crate.io/docs/sql-99/en/latest/chapters/36.html" target="_blank">Chapter 36 – SQL Transactions</a></li><li><a href="https://crate.io/docs/sql-99/en/latest/chapters/37.html" target="_blank">Chapter 37 – SQL Transaction Concurrency</a></li></ul></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">86</span></div></div></div></div>
<div class="slide"><div class="content"><h1>Дополнительная литература</h1><div class="body"><ul class="item-1 level-1"><li><em>Mohan C.</em>, <em>Haderle D.</em>, <em>Lindsay B.</em>, <em>Pirahesh H.</em>, <em>Schwarz P.</em><a href="https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.109.2480" target="_blank">ARIES: A Transaction Recovery Method Supporting Fine-Granularity Locking and Partial Rollbacks Using Write-Ahead Logging</a></li><li><em>Mohan C.</em><a href="https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.42.740" target="_blank">Repeating History Beyond ARIES</a></li><li><em>Bernstein P. A.</em>, <em>Hadzilacos V.</em>, <em>Goodman N.</em><br ignore="ignore" /><a href="https://www.microsoft.com/en-us/research/people/philbe/book/" target="_blank">Concurrency Control and Recovery in Database Systems</a></li></ul></div><div class="footer"><div class="test"><span class="author">Георгий Корнеев</span><span class="title">Базы данных / Транзакции</span><span class="number">87</span></div></div></div></div></div></body></html>